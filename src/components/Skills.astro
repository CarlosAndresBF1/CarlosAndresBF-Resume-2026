---
import type { Lang } from "../i18n";
import { useTranslations } from "../i18n";

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
const skills = t.skills;

// Flatten all skill items for the interactive grid
const allSkillItems = skills.categories.flatMap((cat: any) => cat.items);
---

<section class="skills flex-col-wise full-vh mt-5" id="skills">
  <div class="container">
    <div>
      <h1 class="mt-5 titleFont text-left shadow">{skills.title}</h1>
    </div>
    <div class="row p-0 m-0">
      <div class="skillsContainer text-center col-lg-6 col-12">
        {
          skills.categories.map((category: any) => (
            <div class="skill-category mb-3">
              <p
                class="normalFont text-left mb-1"
                style="font-size:14px; color: var(--text-theme-secondary); border-bottom: 1px solid #333; padding-bottom: 5px;"
              >
                {category.name}
              </p>
              <div class="row">
                {category.items.map((item: any) => (
                  <div class="col-lg-4 col-4 p-0">
                    <p
                      class="skillpara"
                      data-content={item.name}
                      data-description={item.description}
                      data-workplaces={JSON.stringify(item.workplaces || [])}
                      data-years={item.years || ""}
                    >
                      {item.name}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          ))
        }
      </div>
      <div class="skillsDiscription col-lg-6 col-12">
        <div class="main-content active p-2" id="mainContent">
          <h3>{allSkillItems[0]?.name}</h3>
          {
            allSkillItems[0]?.years && (
              <span class="skill-years-badge">
                {allSkillItems[0].years} {lang === "es" ? "años" : "years"}
              </span>
            )
          }
          <p class="normalFont text-justify mt-2">
            {allSkillItems[0]?.description}
          </p>
          {
            allSkillItems[0]?.workplaces &&
              allSkillItems[0].workplaces.length > 0 && (
                <div class="skill-workplaces">
                  <h6>
                    {lang === "es" ? "Experiencia en:" : "Experience at:"}
                  </h6>
                  <ul>
                    {allSkillItems[0].workplaces.map((wp: string) => (
                      <li>{wp}</li>
                    ))}
                  </ul>
                </div>
              )
          }
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const mainContent = document.getElementById("mainContent");
    const boxes = Array.from(document.querySelectorAll(".skillpara"));
    let activeBox: HTMLElement | null = null;

    const showContent = (e: Event) => {
      const target = e.target as HTMLElement;
      const name = target.getAttribute("data-content");
      const description = target.getAttribute("data-description");
      const workplacesRaw = target.getAttribute("data-workplaces");
      const years = target.getAttribute("data-years");

      // Toggle: if clicking the same skill, deselect it
      if (activeBox === target) {
        activeBox.classList.remove("skill-active");
        activeBox = null;
        if (mainContent) {
          mainContent.innerHTML = "";
          mainContent.classList.remove("active");
        }
        return;
      }

      // Remove previous active
      if (activeBox) activeBox.classList.remove("skill-active");
      activeBox = target;
      target.classList.add("skill-active");

      if (mainContent && name && description) {
        let workplaces: string[] = [];
        try {
          workplaces = JSON.parse(workplacesRaw || "[]");
        } catch {
          workplaces = [];
        }

        let html = `<h3>${name}</h3>`;
        if (years) {
          html += `<span class="skill-years-badge">${years} ${document.documentElement.lang === "es" ? "años" : "years"}</span>`;
        }
        html += `<p class="normalFont text-justify mt-2">${description}</p>`;
        if (workplaces.length > 0) {
          html += `<div class="skill-workplaces"><h6>${document.documentElement.lang === "es" ? "Experiencia en:" : "Experience at:"}</h6><ul>`;
          workplaces.forEach((wp: string) => {
            html += `<li>${wp}</li>`;
          });
          html += `</ul></div>`;
        }

        mainContent.innerHTML = html;
        mainContent.classList.add("active");
      }
    };

    boxes.forEach((box) => {
      box.addEventListener("click", showContent);
    });
  });
</script>

<style>
  .skill-category {
    margin-bottom: 10px;
  }
  .skillsContainer div p {
    margin: 5px 5px;
    padding: 15px;
    cursor: pointer;
    background-color: var(--bg-theme-secondary);
    border-radius: 5px;
    color: var(--text-theme-secondary);
    font-size: 14px;
  }
  .skillsContainer div p:hover {
    background: rgb(255, 255, 255);
    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0.093) 0%,
      rgba(0, 0, 0, 1) 30%,
      rgba(0, 0, 0, 1) 70%,
      rgba(255, 255, 255, 0.208) 100%
    );
  }
  .skillsContainer div p.skill-active {
    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0.15) 0%,
      rgba(50, 50, 50, 1) 30%,
      rgba(50, 50, 50, 1) 70%,
      rgba(255, 255, 255, 0.25) 100%
    );
    border-left: 3px solid #fff;
  }
  .skillsDiscription {
    margin: 5px 0px;
    padding: 20px;
    border-radius: 5px;
    background-color: rgba(188, 186, 186, 0.126);
    min-height: 300px;
  }
  .skillsDiscription div {
    margin: 5px 5px;
    padding: 5px;
    opacity: 0;
    transition: opacity 0.3s ease;
    background-color: rgba(188, 186, 186, 0.126);
    color: var(--text-theme-secondary);
  }
  .main-content {
    border-radius: 5px;
    height: 100%;
  }
  .main-content.active {
    opacity: 1;
  }
  .skill-years-badge {
    display: inline-block;
    background-color: rgba(255, 255, 255, 0.15);
    color: #fff;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    border: 1px solid rgba(255, 255, 255, 0.25);
  }
  .skill-workplaces {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  .skill-workplaces h6 {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 8px;
  }
  .skill-workplaces ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .skill-workplaces ul li {
    padding: 4px 0;
    font-size: 14px;
    color: var(--text-theme-secondary);
    position: relative;
    padding-left: 16px;
  }
  .skill-workplaces ul li::before {
    content: "▸";
    position: absolute;
    left: 0;
    color: rgba(255, 255, 255, 0.4);
  }
  @media only screen and (max-width: 600px) {
    .skills {
      padding: 50px 0px;
    }
  }
</style>
